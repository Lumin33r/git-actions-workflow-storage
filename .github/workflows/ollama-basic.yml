name: Ollama AI Processing

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ai-processing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: System information
        run: |
          echo "Runner OS: ${{ runner.os }}"
          df -h
          free -h

      - name: Cache Ollama models
        uses: actions/cache@v3
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-llama3.2-1b

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama service
        run: |
          ollama serve &
          sleep 10

      - name: Download AI model
        run: |
          if ! ollama list | grep -q "llama3.2:1b"; then
            ollama pull llama3.2:1b
          fi

      - name: Initialize monitoring
        run: |
          python -c "
          import sys
          sys.path.append('.')
          from monitoring.dashboard import WorkflowMonitor
          monitor = WorkflowMonitor('ollama-enterprise')
          monitor.start_monitoring('${{ github.run_number }}', '${{ github.sha }}')
          "

      - name: Run monitored tests
        run: python scripts/test_runner.py
        continue-on-error: true

      - name: Create result directory
        run: |
          python -c "
          import sys
          sys.path.append('.')
          from utils.directory_manager import DirectoryManager
          dm = DirectoryManager('results')
          result_dir = dm.create_timestamped_dir('run-${{ github.run_number }}')
          with open('current_result_dir.txt', 'w') as f:
              f.write(str(result_dir))
          "

      - name: Generate AI analysis
        run: |
          RESULT_DIR=$(cat current_result_dir.txt)
          ollama run llama3.2:1b "Explain enterprise monitoring benefits." > "$RESULT_DIR/ai_analysis.txt"

      - name: Generate monitoring summary
        if: always()
        run: |
          python -c "
          import sys, shutil
          from pathlib import Path
          sys.path.append('.')
          from monitoring.dashboard import WorkflowMonitor

          monitor = WorkflowMonitor('ollama-enterprise')
          monitor.start_monitoring('${{ github.run_number }}', '${{ github.sha }}')

          result_dir = Path(open('current_result_dir.txt').read().strip())
          summary = monitor.generate_summary(result_dir)

          if Path('logs').exists():
              shutil.copytree('logs', result_dir / 'logs', dirs_exist_ok=True)
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: enterprise-results-${{ github.run_number }}
          path: |
            results/
            logs/
          retention-days: 30
